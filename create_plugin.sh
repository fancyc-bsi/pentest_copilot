#!/bin/bash

# Script to create a YAML configuration for a new plugin
echo "Welcome to the Plugin Template Creator for Pentest Copilot"

# Directory containing the plugins
plugins_dir="./plugins"

# Function to get user input
get_input() {
    read -p "$1" input
    echo "$input"
}

# Function to display existing plugins
list_plugins() {
    echo "Current plugins:"
    echo "ID  | Description"
    echo "----|----------------"
    for file in "$plugins_dir"/*.yaml; do
        if [[ "$file" == *config.yaml ]]; then
            continue
        fi
        id=$(grep '^id:' "$file" | awk '{print $2}')
        desc=$(grep '^description:' "$file" | sed -r 's/description: "(.+)"/\1/')
        printf "%-4s| %s\n" "$id" "$desc"
    done
    echo "-------------------------"
}

# List existing plugins
list_plugins

# Check if the plugin ID already exists
id=$(get_input "Enter the new plugin ID: ")
filename="${plugins_dir}/${id}.yaml"

if [[ -f "$filename" ]]; then
    echo "Error: A plugin with ID $id already exists."
    exit 1
fi

# Collecting information about the new plugin
description=$(get_input "Enter the plugin description: ")
command=$(get_input "Enter the command to run: ")

# Collect arguments in an array
args=()
echo "Enter arguments one at a time (type 'done' when finished):"
while true; do
    arg=$(get_input "Argument: ")
    if [[ "$arg" == "done" ]]; then
        break
    fi
    args+=("$arg")
done

# Boolean settings
needs_port=$(get_input "Does this need a port? (true/false): ")
requires_http=$(get_input "Does this require HTTP? (true/false): ")
requires_https=$(get_input "Does this require HTTPS? (true/false): ")
include_port_in_url=$(get_input "Should the port be included in the URL? (true/false): ")

# Writing to the YAML file
echo "# ${id}.yaml - ${description}" > $filename
echo "id: $id" >> $filename
echo "description: \"$description\"" >> $filename
echo "command: \"$command\"" >> $filename
echo "args:" >> $filename
for arg in "${args[@]}"; do
    echo "  - \"$arg\"" >> $filename
done
echo "needs_port: $needs_port" >> $filename
echo "requires_http: $requires_http" >> $filename
echo "requires_https: $requires_https" >> $filename
echo "include_port_in_url: $include_port_in_url" >> $filename

echo "Plugin template '$filename' created successfully."

echo "Don't forget to add the new plugin in the config.yaml!!!"