use pulldown_cmark::{Parser, html::push_html};

pub struct Renderer;

impl Renderer {
    pub fn render_to_html(markdown: &str) -> String {
        let parser = Parser::new(markdown);
        let mut html_output = String::new();
        push_html(&mut html_output, parser);
        Self::add_styling_with_bootstrap(&mut html_output);
        html_output
    }

    fn add_styling_with_bootstrap(html: &mut String) {
        let bootstrap_cdn = r#"<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">"#;
        let toc_script = r#"<script>
            document.addEventListener("DOMContentLoaded", function() {
                const headings = document.querySelectorAll('h2, h3');
                const toc = document.getElementById('toc');
                headings.forEach(heading => {
                    const id = heading.textContent.replace(/ /g, '_').toLowerCase();
                    heading.id = id;
                    const entry = document.createElement('a');
                    entry.href = '#' + id;
                    entry.textContent = heading.textContent;
                    entry.className = heading.tagName.toLowerCase();
                    toc.appendChild(entry);
                    toc.appendChild(document.createElement('br'));
                });
            });
        </script>"#;

        let styled_html = format!(
            r#"<!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                {}
                <style>
                    body {{
                        background-color: #343a40; /* Dark background for the body */
                        color: #f8f9fa; /* Light text color */
                        padding-top: 2rem;
                        padding-bottom: 2rem;
                        display: flex;
                    }}
                    .container {{
                        flex-grow: 1;
                        padding-left: 220px; /* Space for the TOC */
                    }}
                    #toc {{
                        position: fixed;
                        left: 20px;
                        top: 20px;
                        width: 180px;
                        background-color: #444; /* Lighter background for TOC */
                        padding: 10px;
                        border-radius: 5px;
                        height: 90vh;
                        overflow-y: auto; /* Make TOC scrollable */
                    }}
                    #toc a {{
                        color: #f8f9fa;
                        text-decoration: none;
                        display: block;
                        margin-bottom: 5px;
                    }}
                    #toc a.h2 {{ font-weight: bold; }}
                    #toc a.h3 {{ margin-left: 10px; }}
                    h2, h3 {{
                        border-bottom: 1px solid #666; /* Subtle separator for better section distinction */
                    }}
                    h2 {{
                        padding-bottom: 0.5rem; /* Space below the h2 for visual separation */
                        margin-top: 2rem; /* Spacing before new host section */
                        color: #ff7f50; /* Coral color for host headings */
                    }}
                    h3 {{
                        color: #ffd700; /* Gold color for port headings */
                    }}
                    pre, code {{
                        background-color: #23272b; /* Slightly lighter dark background for code blocks */
                        border: 1px solid #444; /* Darker border for emphasis */
                        border-radius: .25rem;
                        color: #f8f9fa;
                    }}
                    pre {{
                        padding: 0.5rem; /* Padding inside pre elements */
                    }}
                </style>
                {}
            </head>
            <body>
                <div id="toc"></div>
                <div class="container">
                    {}
                </div>
            </body>
            </html>"#,
            bootstrap_cdn, // Pass Bootstrap CDN
            toc_script, // Pass the TOC script
            html // Pass the HTML content that was converted from Markdown
        );

        *html = styled_html;
    }
}
